!function(t){var i={};function e(s){if(i[s])return i[s].exports;var h=i[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,e),h.l=!0,h.exports}e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var h in t)e.d(s,h,function(i){return t[i]}.bind(null,h));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=1)}([function(t){t.exports=JSON.parse('{"name":"Plants and Spiders","timing":{"showSeeds":7,"startLights":2,"delayBetweenLights":1},"levels":[{"id":0,"numberOfSpiders":10},{"id":1,"numberOfSpiders":15},{"id":2,"numberOfSpiders":20},{"id":3,"numberOfSpiders":25}]}')},function(t,i,e){"use strict";e.r(i);const s=document.querySelector("canvas"),h=s.getContext("2d");s.width=innerWidth,s.height=innerHeight;const a=document.createElement("canvas"),n=a.getContext("2d");a.width=innerWidth,a.height=innerHeight;let o=s.height-15;s.width,s.height;window.addEventListener("resize",()=>{s.width=innerWidth,s.height=innerHeight,a.width=innerWidth,a.height=innerHeight,o=s.height-15});class r{constructor(){this.keyStates=new Map,this.keyMap=new Map}addMapping(t,i){this.keyMap.set(t,i)}handleEvent(t){const{code:i}=t;if(!this.keyMap.has(i))return;t.preventDefault();const e="keydown"===t.type;this.keyStates.get(i)!==e&&(this.keyStates.set(i,e),this.keyMap.get(i)(e))}listenTo(t){["keydown","keyup"].forEach(i=>{t.addEventListener(i,t=>{this.handleEvent(t)})})}}var d=e.p+"33df3f0790cee72bb6d12c5d2a1240b9.mp3",l=e.p+"930b82081238d08754da34145e2e3e11.mp3",g=e.p+"aa23f122d6523a5a8e8979ea2446eae1.mp3";const c=new class{constructor(){this.audioContext=new AudioContext,this.audioBuffers=new Map}loadAudio(t){return fetch(t).then(t=>t.arrayBuffer()).then(t=>this.audioContext.decodeAudioData(t))}addAudio(t,i){this.audioBuffers.set(t,i)}playAudio(t){const i=this.audioContext.createBufferSource();i.connect(this.audioContext.destination),i.buffer=this.audioBuffers.get(t)}};function p(t){return new Promise(i=>{const e=new Image;e.addEventListener("load",()=>{i(e)}),e.src=t})}function m(t){return fetch(`manifests/${t}.json`).then(t=>t.json())}c.loadAudio(d).then(t=>{c.addAudio("gunshot",t)}),c.loadAudio(l).then(t=>{c.addAudio("splash",t)}),c.loadAudio(g).then(t=>{c.addAudio("glass",t)}),Promise.all([c.loadAudio(d),c.loadAudio(l),c.loadAudio(g)]).then(([t,i,e])=>{c.addAudio("gunshot",t),c.addAudio("splash",i),c.addAudio("glass",e)});class w{constructor(t){this.manifest=t,this.direction={left:!1,right:!1,jumping:!1},this.isOnGround=!0,this.deltaX=0,this.deltaY=0,this.angle=0,this.velocityX=6,this.velocityY=0,this.gravity=.6,this.flip=!1,this.shot=!1,this.distance=0,this.ready=!1,this.lowerBody={...this.manifest.lowerBody,runningAnimation:this.manifest.animations.get("running"),jumpingAnimation:this.manifest.animations.get("jumping")},this.upperBody={...this.manifest.upperBody,x:this.x-30,y:this.y-this.lowerBody.height+70},this.x=0,this.y=s.height-15-this.lowerBody.height+5,this.flashAnimation={active:!1,duration:3,frame:0,image:this.manifest.flashImage},this.shootingAnimation={active:!1,duration:4,frame:0,size:5}}draw(t){this.upperBody={...this.upperBody,rotationPoint:{x:this.x+this.lowerBody.width/2,y:this.y+25},x:this.x-25,y:this.y-this.lowerBody.height+(this.flip?160:100)},t.strokeStyle="red",this.getFrame(t,`walk-${Math.floor(this.distance/20)%this.lowerBody.runningAnimation.size}`),t.translate(this.upperBody.rotationPoint.x,this.upperBody.rotationPoint.y),t.rotate(this.angle),t.translate(-this.upperBody.rotationPoint.x,-this.upperBody.rotationPoint.y),t.strokeStyle="limegreen",this.runShootingAnimation(),t.drawImage(this.flip?this.upperBody.imageFlipped:this.upperBody.image,this.upperBody.x,this.upperBody.y,this.upperBody.width,this.upperBody.height),t.setTransform(1,0,0,1,0,0),t.fillStyle="blue"}move(){this.velocityY+=this.gravity,this.y+=this.velocityY,this.y+this.lowerBody.height>=o&&(this.y=o-this.lowerBody.height,this.isOnGround=!0,this.velocityY=0),this.direction.left?this.x>0&&(this.x-=this.velocityX,this.distance+=this.velocityX):this.direction.right?this.x<s.width-this.upperBody.width&&(this.x+=this.velocityX,this.distance+=this.velocityX):this.ready&&(this.distance=0),this.direction.jumping&&this.isOnGround&&(this.velocityY=-12,this.isOnGround=!1)}getFrame(t,i){if(this.isOnGround){const e=this.lowerBody.runningAnimation.get(i);t.drawImage(this.lowerBody.spriteSheet,e.x,this.flip?e.y+e.height:e.y,e.width,e.height,this.x,this.y,this.lowerBody.width,this.lowerBody.height)}else{const i=this.lowerBody.jumpingAnimation.get("jump-0");t.drawImage(this.lowerBody.spriteSheet,i.x,this.flip?i.y+i.height:i.y,i.width,i.height,this.x,this.y,this.lowerBody.width,this.lowerBody.height)}}drawFlash(t){1==this.flashAnimation.active&&(this.flashAnimation.frame>=this.flashAnimation.duration?(this.flashAnimation.frame=0,this.flashAnimation.active=!1):(this.flashAnimation.frame++,t.fillStyle="rgba(249, 191, 0, 0.1)",t.fillRect(0,0,s.width,s.height),t.translate(this.upperBody.rotationPoint.x,this.upperBody.rotationPoint.y),t.rotate(this.angle),t.translate(-this.upperBody.rotationPoint.x,-this.upperBody.rotationPoint.y),t.strokeStyle="limegreen",t.drawImage(this.flashAnimation.image,this.upperBody.x+this.upperBody.width,this.upperBody.y+(this.flip?0:100),this.upperBody.width,this.upperBody.height/2),t.setTransform(1,0,0,1,0,0)))}runShootingAnimation(){this.shootingAnimation.active&&(this.shootingAnimation.frame>=this.shootingAnimation.duration?(this.shootingAnimation.frame=0,this.shootingAnimation.active=!1):(this.shootingAnimation.frame++,this.upperBody.x=this.upperBody.x-this.shootingAnimation.size*this.shootingAnimation.frame))}rotate(t,i){const e=this.x+this.upperBody.width/2-t,s=this.y+this.upperBody.height/2-i;this.angle=Math.atan2(s,e)+Math.PI,this.angle>1.5&&this.angle<4.7?this.flip=!0:this.flip=!1}onClick(){c.playAudio("gunshot"),this.flashAnimation.active=!0,this.shootingAnimation.active=!0}epicEntrance(){return new Promise((t,i)=>{this.x=-this.upperBody.width;const e=setInterval(()=>{var i;this.x<s.width/7?(this.x+=1,this.distance+=2):(clearInterval(e),(t=>{const i=new r;i.addMapping("KeyD",i=>{t.direction.right=i}),i.addMapping("KeyA",i=>{t.direction.left=i}),i.addMapping("Space",i=>{t.direction.jumping=i}),i.listenTo(window)})(this),i=this,s.addEventListener("mousemove",({clientX:t,clientY:e})=>{i.rotate(t,e)}),s.addEventListener("click",t=>{i.onClick()}),this.ready=!0,t())},10)})}}const u=async()=>{const t=await m("character");return t.lowerBody={...t.lowerBody,image:await p(t.lowerBody.imageURL),imageFlipped:await p(t.lowerBody.flippedImageURL),spriteSheet:await p(t.lowerBody.spriteSheetURL)},t.upperBody={...t.upperBody,image:await p(t.upperBody.imageURL),imageFlipped:await p(t.upperBody.flippedImageURL)},t.flashImage=await p(t.flashImageURL),t.animations=function(t){const i=new Map;return t.forEach(t=>{const e=new Map;t.frames.forEach(t=>{e.set(t.name,t.rect)}),i.set(t.name,e)}),i}(t.animationsToBeLoaded),console.log(t.animations),new w(t)};class y{constructor(t){this.manifest=t}draw(t){t.drawImage(this.manifest.image,0,0,s.width,s.height)}}function f(t,i){return Math.floor(Math.random()*(i-t+1)+t)}class v{constructor(t){const{destination:i,position:e,width:s,height:h}=t;this.manifest=t,this.height=s,this.width=h,this.x=e.x,this.y=e.y,this.isShot=!1,this.hasKilledAPlant=!1,this.killer={},this.deltaX=i.x-this.x,this.deltaY=i.y-this.y,this.angle=Math.atan2(this.deltaY,this.deltaX),this.splashAngle=0,this.velocityX=1*Math.cos(this.angle),this.velocityY=1*Math.sin(this.angle),this.direction=this.angle-Math.PI/2,this.distance=0}draw(t){this.isShot||this.hasKilledAPlant?this.hasKilledAPlant||(t.translate(this.x+this.width/2,this.y+this.height/2),t.rotate(-this.splashAngle+Math.PI),t.translate(-this.x-this.width/2,-this.y-this.height/2),t.drawImage(this.manifest.splashImage,this.x-10,this.y-this.height,this.width+20,2*this.height),t.setTransform(1,0,0,1,0,0)):(this.distance+=2,t.translate(this.x+this.width/2,this.y+this.height/2),t.rotate(this.direction),t.translate(-this.x-this.width/2,-this.y-this.height/2),this.getFrame(t,`spider-${Math.floor(this.distance/20)%this.manifest.spriteMap.size}`),t.setTransform(1,0,0,1,0,0),this.checkCollision())}checkCollision(){this.manifest.plants.forEach(t=>{t.plantBoundingRect.x<this.x+this.width&&t.plantBoundingRect.x+t.plantBoundingRect.width>this.x&&t.plantBoundingRect.y<this.y+this.height&&t.plantBoundingRect.y+t.plantBoundingRect.height>this.y&&(t.shrink(),this.hasKilledAPlant=!0)})}getFrame(t,i){const e=this.manifest.spriteMap.get(i);e&&t.drawImage(this.manifest.image,e.x,e.y,e.width,e.height,this.x+=1*this.velocityX,this.y+=1*this.velocityY,this.width,this.height)}onClick(){window.game.state.spidersKilled+=1,c.playAudio("splash"),this.isShot=!0,this.killer={x:this.manifest.character.upperBody.x,y:this.manifest.character.upperBody.y};const t=this.x-(this.killer.x+this.manifest.character.upperBody.width/2),i=this.y-(this.killer.y+100);this.splashAngle=Math.atan2(t,i),window.game.state.spidersKilled===window.game.config.levels[window.game.state.level].numberOfSpiders&&window.game.state.level++}}class B{constructor(t){this.manifest=t}createSpiders(t,i,e){this.manifest.character=i,this.manifest.plants=e;let h=[];for(let i=0;i<t;i++){this.manifest.position={x:f(-200,s.width+200),y:f(-200,0)};const t=f(25,80);this.manifest.width=t,this.manifest.height=t;const i=e[f(0,e.length-1)];this.manifest.destination={x:i.x+i.width/2,y:i.y},h.push(new v(this.manifest))}return h}}document.querySelector("#overlay");class x{constructor(t){this.manifest=t}createPlants(t){const{width:i,height:e,image:h,loadedPlantImages:a,potMargin:n,plantSizes:r}=this.manifest,d=[],l=i*t+n*(t-1),g=(s.width-l)/2;for(let s=0;s<t;s++)d.push(new S(g+(i+(s===t?0:n))*s,o-e,r,h,a,s));return(t=>{console.log("adsa"),document.querySelectorAll(".seedButton").forEach(i=>{i.addEventListener("click",({target:i})=>{t[i.dataset.id].plantSeed()})})})(d),d}}class S{constructor(t,i,e,s,h,a){this.id=a,this.x=t,this.y=i-15,this.size=0,this.plantSizes=e,this.planted=!1,this.showSeed=!0,this.plantImages=h,this.width=170,this.height=120,this.potCenter={x:this.x+this.width/2,y:this.y+this.height/2},this.image=s,this.timeToShowSeedButton=1,this.activePlant=e[this.size],this.activePlantImage=h[this.size],this.plantBoundingRect={x:this.potCenter.x-this.activePlant.width/2,y:this.y-this.activePlant.height,width:this.activePlant.width,height:this.activePlant.height},this.createSeedButton()}draw(t){t.drawImage(this.image,this.x,this.y,this.width,this.height),this.planted&&t.drawImage(this.activePlantImage,this.plantBoundingRect.x,this.plantBoundingRect.y,this.plantBoundingRect.width,this.plantBoundingRect.height)}grow(){this.size<this.plantImages.length-1&&this.planted&&(this.size++,this.activePlant=this.plantSizes[this.size],this.activePlantImage=this.plantImages[this.size],this.plantBoundingRect={x:this.potCenter.x-this.activePlant.width/2,y:this.y-this.activePlant.height,width:this.activePlant.width,height:this.activePlant.height})}shrink(){console.log(this.size),this.size>0&&this.planted?(this.size--,this.activePlant=this.plantSizes[this.size],this.activePlantImage=this.plantImages[this.size],this.plantBoundingRect={x:this.potCenter.x-this.activePlant.width/2,y:this.y-this.activePlant.height,width:this.activePlant.width,height:this.activePlant.height}):(this.size=-1,this.planted=!1)}onClick(){this.grow()}plantSeed(){window.game.state.seedsPlanted+=1,this.planted=!0,document.querySelector(`.seedButton[data-id="${this.id}"]`).outerHTML=""}showSeedButton(){document.querySelector(`.seedButton[data-id="${this.id}"]`).classList.add("active")}createSeedButton(){overlay.innerHTML+=`\n        <div \n            class="seedButton"\n            data-id="${this.id}"\n            style="left: ${this.potCenter.x-40}px; top: ${this.potCenter.y-160}px;" \n        >\n            <div class="seedButton__image" data-id="${this.id}">\n            </div>\n        </div>\n        `}}class A{constructor(t,i,e,s,h,a,n,o,r,d){this.id=t,this.width=s,this.height=h,this.x=i,this.y=e,this.lampCenter={x:this.x+this.width/2,y:this.y+this.height/2},this.turnedOn=!1,this.color=n,this.lightWidth=o,this.image=a,this.offset=10,this.isShot=!1,this.perspective=40,this.turnOn=r,this.numberOfLights=d}drawLight(t){this.turnedOn&&(t.beginPath(),t.moveTo(this.x+this.offset,this.y+this.height),0==this.id?(t.lineTo(this.x-this.lightWidth,s.height-65),t.lineTo(this.x-this.lightWidth-this.perspective,s.height)):t.lineTo(this.x-this.lightWidth,s.height),this.id==this.numberOfLights-1?(t.lineTo(this.x+ +this.width+this.lightWidth+this.perspective,s.height),t.lineTo(this.x+this.width+this.lightWidth,s.height-65)):t.lineTo(this.x+this.width+this.lightWidth,s.height),t.lineTo(this.x+this.width-this.offset,this.y+this.height),t.closePath(),t.fillStyle=this.color,t.fill())}drawBody(t){t.drawImage(this.image,this.x,this.y,this.width,this.height)}draw(t){this.drawBody(t),this.drawLight(n)}onClick(){this.isShot||c.playAudio("glass"),this.isShot=!0}}class P{constructor(t){this.manifest=t}createLights(t,i){const{width:e,height:h,image:a,color:n,lightWidth:o,lightMargin:r}=this.manifest,d=[],l=e*t+r*(t-1),g=(s.width-l)/2;for(let s=0;s<t;s++){const l=new A(s,g+(e+(s===t?0:r))*s,0,e,h,a,n,o,s+i,t);d.push(l)}return d}}class L{constructor(){this.startTime=0,this.timeElapsed=0}start(){this.startTime=new Date}logTimeElapsed(){let t=(new Date-this.startTime)/1e3,i=Math.round(t);this.timeElapsed!=i&&(this.timeElapsed=i)}getTimeElapsed(){return this.timeElapsed}}(async t=>{window.game={config:t,state:{seedsPlanted:0,seedsShown:!1,spidersKilled:0,level:-1,currentLevel:-1,gameOver:!1}};const i=new L,e=await u(),o=await(async()=>{const t=await m("scene");return t.image=await p(t.mainImageURL),new y(t)})(),r=await(async()=>{const t=await m("plant");return t.image=await p(t.mainImageURL),console.log(t),t.loadedPlantImages=[],t.plantImages.forEach(async i=>{t.loadedPlantImages.push(await p(i))}),new x(t)})(),d=await(async()=>{const t=await m("light");return t.image=await p(t.mainImageURL),new P(t)})(),l=await(async()=>{const t=await m("spider");t.image=await p(t.mainImageURL),t.splashImage=await p(t.splashImageURL);const i=new Map;return t.frames.forEach(t=>{i.set(t.name,t.rect)}),t.spriteMap=i,new B(t)})(),g=r.createPlants(3),c=d.createLights(3,t.timing.startLights);let w=[];e.epicEntrance().then(()=>{}),s.addEventListener("click",t=>{(({clientX:t,clientY:i},e,s)=>{s(e.find(e=>!e.isShot&&t>e.x&&t<e.x+e.width&&i>e.y&&i<e.y+e.height))})(t,[...c,...w,...g],t=>{t&&t.onClick()})}),i.start();const f=()=>{h.globalCompositeOperation="normal",o.draw(h),e.move(),w.forEach(t=>{t.draw(h)}),t.timing.showSeeds==i.getTimeElapsed()&&(window.game.state.level=0),0===window.game.state.level&&0!==window.game.state.currentLevel?(window.game.state.seedsPlanted==g.length&&0==w.length&&(window.game.state.currentLevel=0,w=l.createSpiders(window.game.config.levels[0].numberOfSpiders,e,g)),window.game.state.seedsShown||(window.game.state.seedsShown=!0,g.forEach(t=>{t.showSeed&&(t.showSeedButton(),t.showSeed=!1)}))):1===window.game.state.level&&1!==window.game.state.currentLevel?(window.game.state.currentLevel=1,window.game.state.spidersKilled=0,g.forEach(t=>{t.grow()}),w=[],w=l.createSpiders(window.game.config.levels[1].numberOfSpiders,e,g)):2===window.game.state.level&&2!==window.game.state.currentLevel?(window.game.state.currentLevel=2,window.game.state.spidersKilled=0,g.forEach(t=>{t.grow()}),w=[],w=l.createSpiders(window.game.config.levels[2].numberOfSpiders,e,g)):3===window.game.state.level&&3!==window.game.state.currentLevel?(window.game.state.currentLevel=3,window.game.state.spidersKilled=0,g.forEach(t=>{t.grow()}),w=[],w=l.createSpiders(window.game.config.levels[3].numberOfSpiders,e,g)):4===window.game.state.level&&4!==window.game.state.currentLevel&&(window.game.state.currentLevel=4,window.game.state.gameOver=!0),g.forEach(t=>{t.draw(h)}),e.draw(h),n.fillStyle="rgb(68, 68, 68)",n.fillRect(0,0,a.width,a.height),e.drawFlash(n),c.forEach(t=>{t.isShot?t.drawBody(h):(t.turnedOn||t.turnOn!=i.getTimeElapsed()||(t.turnedOn=!0),t.drawBody(h),t.drawLight(n))}),h.globalCompositeOperation="multiply",h.drawImage(a,0,0),i.logTimeElapsed(),window.game.state.gameOver?document.querySelector("#gameOverScreen").classList.remove("hidden"):window.requestAnimationFrame(f)};return()=>{window.requestAnimationFrame(f)}})(e(0)).then(t=>{console.log("All systems are go!"),t()})}]);